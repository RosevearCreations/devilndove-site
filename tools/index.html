<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Tools — Devil n Dove</title>
  <link rel="stylesheet" href="/css/styles.css" />
  <link rel="icon" type="image/png" href="/assets/mark.png" />

  <!-- Toolshed-specific layout polish (keeps cards tidy even with mixed image sizes) -->
  <style>
    /* Keep the Toolshed grid tidy regardless of image dimensions */
    .area-block { margin-top: 18px; }
    .area-head {
      display:flex; align-items:baseline; justify-content:space-between;
      gap:12px; margin: 10px 0 10px;
    }
    .area-head h2 { margin:0; font-size: 18px; }
    .area-head .muted { opacity:.75; font-size: 13px; }

    /* Card grid */
    .subgrid{
      display:grid;
      grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
      gap: 12px;
    }

    /* Compact card */
    .tool.card{
      padding: 0;
      overflow: hidden;
      display:flex;
      flex-direction: column;
      min-height: 320px;
    }

    /* Fixed image box */
    .tool.card .thumb{
      height: 160px;              /* <- consistent image height */
      width: 100%;
      background: rgba(255,255,255,0.03);
      border-bottom: 1px solid rgba(255,255,255,0.06);
      display:flex;
      align-items:center;
      justify-content:center;
      overflow:hidden;
    }
    .tool.card .thumb img{
      width: 100%;
      height: 100%;
      object-fit: contain;        /* <- keeps full image visible, no cropping */
      display:block;
    }

    /* Compact body */
    .tool.card .body{
      padding: 12px;
      display:flex;
      flex-direction: column;
      gap: 8px;
      flex: 1;
    }

    .tool.card .tname{
      font-weight: 800;
      line-height: 1.2;
      font-size: 14px;
      margin: 0;
      display:-webkit-box;
      -webkit-line-clamp: 2;      /* <- prevent super tall titles */
      -webkit-box-orient: vertical;
      overflow:hidden;
    }

    .tool.card .tags{
      display:flex;
      flex-wrap:wrap;
      gap: 6px;
      margin-top: 2px;
    }
    .tool.card .tag{
      font-size: 11px;
      padding: 3px 8px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,0.12);
      opacity: .9;
      white-space: nowrap;
    }

    .tool.card .use{
      font-size: 12px;
      opacity: .85;
      line-height: 1.35;
      display:-webkit-box;
      -webkit-line-clamp: 3;      /* <- keep notes tidy */
      -webkit-box-orient: vertical;
      overflow:hidden;
    }

    .tool.card .actions{
      margin-top: auto;           /* <- pushes button to the bottom */
      padding-top: 6px;
    }
    .tool.card .btnlink{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap: 8px;
      width: 100%;
      text-decoration:none;
      font-size: 12px;
      padding: 10px 10px;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,0.14);
      background: rgba(255,255,255,0.06);
    }
    .tool.card .btnlink:hover{
      background: rgba(255,255,255,0.10);
    }

    /* Controls row spacing */
    .tools-controls .input { width: 100%; }
  </style>
</head>
<body>
  <div class="container">
    <div class="nav">
      <div class="brand">
        <img src="/assets/logo-clear.png" alt="Devil n Dove logo" />
        <div>
          <div style="font-weight:800;letter-spacing:.2px;line-height:1.1">Devil n Dove</div>
          <div class="small">Workshop • Art • Tools • Movies</div>
        </div>
      </div>
      <div style="display:flex;gap:14px;flex-wrap:wrap">
        <a href="/index.html">Home</a>
        <a href="/about/index.html">About</a>
        <a href="/gallery/index.html">Art</a>
        <a href="/tools/index.html">Tools</a>
        <a href="/shop/index.html">Shop</a>
        <a href="/movies/index.html">Movies</a>
        <a href="/contact/index.html">Contact</a>
      </div>
    </div>

    <div class="hero">
      <span class="badge">Tools & Supplies</span>
      <div class="hero-grid" style="margin-top:12px">
        <div class="card" style="padding:18px">
          <h1>What we use (and what we’ve learned).</h1>
          <p>
            This is our running list of tools, consumables, and “can’t-live-without-it” supplies.
            We’ll show real photos, honest notes, and the little things that make the work smoother.
          </p>
        </div>
        <div class="hero-media">
          <img src="/assets/hero-workshop.webp" alt="Illustrated workshop scene" />
        </div>
      </div>
    </div>

    <div class="grid">
      <div class="card">
        <h3>Sections we’ll build</h3>
        <ul class="small clean">
          <li>Laser & engraving</li>
          <li>3D printing & design</li>
          <li>CNC & machining</li>
          <li>Casting & forging</li>
          <li>Finishing, polishing, and safety</li>
          <li>Consumables: blades, bits, papers, resins, adhesives, etc.</li>
        </ul>
      </div>

      <div class="card">
        <h3>How we’ll present each tool</h3>
        <ul class="small clean">
          <li>Our photo (not a stock image)</li>
          <li>What we use it for</li>
          <li>One tip we wish we knew earlier</li>
          <li>Optional link for reference</li>
        </ul>
        <div class="hr"></div>
        <p class="small">
          Start with 20 tools. Once the layout feels right, we can scale up to hundreds quickly.
        </p>
      </div>
    </div>

    <div class="card tools-controls" style="margin-top:14px">
      <div class="grid" style="grid-template-columns:1fr 220px 220px;gap:10px;align-items:end">
        <div>
          <label class="small">Search</label>
          <input id="toolSearch" class="input" placeholder="Type a tool name…" />
        </div>

        <div>
          <label class="small">Area</label>
          <select id="toolArea" class="input">
            <option value="all">All</option>
          </select>
        </div>

        <div>
          <label class="small">Category</label>
          <select id="toolCat" class="input">
            <option value="all">All</option>
          </select>
        </div>
      </div>

      <div class="small" style="margin-top:10px">
        Showing <span id="toolShown">0</span> of <span id="toolTotal">0</span>
      </div>

      <div id="toolsGrid" style="margin-top:12px"></div>

      <div class="small" style="margin-top:12px">
        Links go to an Amazon.ca search page (not affiliate links). We use our own photos whenever possible.
      </div>
    </div>

    <div class="footer">
      Toolshed images are served from our R2 bucket via <span class="small">assets.devilndove.com</span>.
    </div>
  </div>

  <script src="/js/main.js"></script>
  <script>
    // Minimal escape (safe even if main.js defines its own)
    function escapeHtml(s){
      return String(s ?? '')
        .replaceAll('&', '&amp;')
        .replaceAll('<', '&lt;')
        .replaceAll('>', '&gt;')
        .replaceAll('"', '&quot;')
        .replaceAll("'", '&#39;');
    }

    // ===== R2 IMAGE CONFIG (case-sensitive!) =====
    const ASSET_ORIGIN = "https://assets.devilndove.com";
    const ASSET_PREFIX = "/Toolshed"; // folder in R2 (capital T)

    function toolImageUrl(fileName){
      if(!fileName) return "";
      return `${ASSET_ORIGIN}${ASSET_PREFIX}/${encodeURIComponent(String(fileName))}`;
    }

    function amazonSearchUrl(name){
      return `https://www.amazon.ca/s?k=${encodeURIComponent(name || "")}`;
    }

    const grid    = document.querySelector('#toolsGrid');
    const search  = document.querySelector('#toolSearch');
    const areaSel = document.querySelector('#toolArea');
    const catSel  = document.querySelector('#toolCat');
    const shown   = document.querySelector('#toolShown');
    const total   = document.querySelector('#toolTotal');

    const AREA_ORDER = [
      "Security","Safety & PPE","Forge & Metalwork","Resin & UV","Clay",
      "Laser & Engraving","3D & CNC","Sublimation","Craft & Cutting",
      "Hand Tools","Measuring & Layout","Organization & Storage","Power & Tech",
      "Filming & Streaming","Automotive","Reference","Pets","Health & Comfort","Workshop Basics"
    ];
    const areaRank = new Map(AREA_ORDER.map((a,i)=>[a,i]));
    const norm = (s)=> (s||'').toString().toLowerCase().trim();
    const getArea = (t)=> t.area || t.primary_area || 'Workshop Basics';

    const byAreaThenName = (a,b)=>{
      const ra = areaRank.has(a) ? areaRank.get(a) : 999;
      const rb = areaRank.has(b) ? areaRank.get(b) : 999;
      if(ra!==rb) return ra-rb;
      return a.localeCompare(b);
    };

    function buildCard(t){
      // Use exporter field to preserve exact filename casing
      const fileName = t.example_image_file || t.image || "";
      const area = getArea(t);
      const cat  = t.category || 'Uncategorized';
      const name = t.name || t.item_name_suggested || fileName || 'Tool';

      const img = toolImageUrl(fileName);
      const amz = t.amazon_search || t.amazon_url || amazonSearchUrl(name);

      const use = t.how_we_use || t.notes || "";

      return `
        <div class="tool card">
          <div class="thumb">
            <img src="${img}" alt="${escapeHtml(name)}" loading="lazy">
          </div>
          <div class="body">
            <div class="tname">${escapeHtml(name)}</div>
            <div class="tags">
              <span class="tag">${escapeHtml(area)}</span>
              <span class="tag">${escapeHtml(cat)}</span>
            </div>
            ${use ? `<div class="use">${escapeHtml(use)}</div>` : ``}
            <div class="actions">
              <a class="btnlink" href="${amz}" target="_blank" rel="noopener">Amazon.ca search</a>
            </div>
          </div>
        </div>`;
    }

    function render(list,totalCount){
      shown.textContent = String(list.length);
      total.textContent = String(totalCount);

      const groups = {};
      list.forEach(t=>{
        const a = getArea(t);
        (groups[a] ||= []).push(t);
      });

      Object.keys(groups).forEach(a=>{
        groups[a].sort((x,y)=>{
          const nx=(x.name||x.item_name_suggested||'').toString();
          const ny=(y.name||y.item_name_suggested||'').toString();
          return nx.localeCompare(ny);
        });
      });

      const areas = Object.keys(groups).sort(byAreaThenName);

      grid.innerHTML = areas.map(a=>`
        <section class="area-block">
          <div class="area-head">
            <h2>${escapeHtml(a)}</h2>
            <div class="muted">${groups[a].length} item${groups[a].length===1?'':'s'}</div>
          </div>
          <div class="subgrid">
            ${groups[a].map(buildCard).join('')}
          </div>
        </section>
      `).join('');
    }

    function applyFilters(tools,totalCount){
      const term = norm(search.value);
      const areaVal = areaSel.value;
      const catVal  = catSel.value;

      let list = tools.slice();
      if(areaVal!=='all') list = list.filter(t=> getArea(t)===areaVal);
      if(catVal!=='all')  list = list.filter(t=> (t.category||'Uncategorized')===catVal);

      if(term){
        list = list.filter(t=>{
          const name = t.name || t.item_name_suggested || '';
          const hay = [
            norm(name), norm(t.category), norm(getArea(t)),
            norm(t.how_we_use), norm(t.notes)
          ].join(' ');
          return hay.includes(term);
        });
      }

      render(list,totalCount);
    }

    async function fetchFirst(urls){
      for(const u of urls){
        try{
          const res = await fetch(u,{cache:"no-store"});
          if(res.ok) return await res.json();
        }catch(e){}
      }
      return null;
    }

    function normalizeTools(payload){
      // Prefer exporter array
      if(Array.isArray(payload)){
        const tools = payload.map(it=>({
          item_name_suggested: it.item_name_suggested,
          example_image_file: it.example_image_file,
          category: it.category || "Uncategorized",
          primary_area: it.primary_area || "Workshop Basics",
          notes: it.notes || "",
          amazon_url: it.amazon_url || (it.amazon_asin ? `https://www.amazon.ca/dp/${it.amazon_asin}` : "")
        }));
        return { tools, totalCount: tools.length };
      }

      // Legacy schema
      if(payload && Array.isArray(payload.items)){
        return { tools: payload.items.slice(), totalCount: Number(payload.count)||payload.items.length };
      }

      return { tools: [], totalCount: 0 };
    }

    async function init(){
      // Try Toolshed exporter FIRST (preserves exact image filename casing)
      const payload = await fetchFirst([
        "/data/toolshed/toolshed_items_master.json",
        "/data/toolshed_items_master.json",
        "/data/tools.json"
      ]);

      if(!payload){
        grid.innerHTML = `<div class="small">Could not load tools data.</div>`;
        return;
      }

      const { tools, totalCount } = normalizeTools(payload);

      const areas = Array.from(new Set(tools.map(getArea))).sort(byAreaThenName);
      areas.forEach(a=>{
        const opt=document.createElement('option');
        opt.value=a; opt.textContent=a;
        areaSel.appendChild(opt);
      });

      const cats = Array.from(new Set(tools.map(t=>t.category||'Uncategorized'))).sort((a,b)=>a.localeCompare(b));
      cats.forEach(c=>{
        const opt=document.createElement('option');
        opt.value=c; opt.textContent=c;
        catSel.appendChild(opt);
      });

      const onChange = ()=> applyFilters(tools,totalCount);
      search.addEventListener('input', onChange);
      areaSel.addEventListener('change', onChange);
      catSel.addEventListener('change', onChange);

      applyFilters(tools,totalCount);
    }

    init();
  </script>
</body>
</html>
