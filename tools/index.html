<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Tools — Devil n Dove</title>
  <link rel="stylesheet" href="/css/styles.css" />
  <link rel="icon" type="image/png" href="/assets/mark.png" />
</head>
<body>
  <div class="container">
    <div class="nav">
      <div class="brand">
        <img src="/assets/logo-clear.png" alt="Devil n Dove logo" />
        <div>
          <div style="font-weight:800;letter-spacing:.2px;line-height:1.1">Devil n Dove</div>
          <div class="small">Workshop • Art • Tools • Movies</div>
        </div>
      </div>
      <div style="display:flex;gap:14px;flex-wrap:wrap">
        <a href="/index.html">Home</a>
        <a href="/about/index.html">About</a>
        <a href="/gallery/index.html">Art</a>
        <a href="/tools/index.html">Tools</a>
        <a href="/shop/index.html">Shop</a>
        <a href="/movies/index.html">Movies</a>
        <a href="/contact/index.html">Contact</a>
      </div>
    </div>

    <div class="hero">
      <span class="badge">Tools & Supplies</span>
      <div class="hero-grid" style="margin-top:12px">
        <div class="card" style="padding:18px">
          <h1>What we use (and what we’ve learned).</h1>
          <p>
            This is our running list of tools, consumables, and “can’t-live-without-it” supplies.
            We’ll show real photos, honest notes, and the little things that make the work smoother.
          </p>
        </div>
        <div class="hero-media">
          <img src="/assets/hero-workshop.webp" alt="Illustrated workshop scene" />
        </div>
      </div>
    </div>

    <div class="grid">
      <div class="card">
        <h3>Sections we’ll build</h3>
        <ul class="small clean">
          <li>Laser & engraving</li>
          <li>3D printing & design</li>
          <li>CNC & machining</li>
          <li>Casting & forging</li>
          <li>Finishing, polishing, and safety</li>
          <li>Consumables: blades, bits, papers, resins, adhesives, etc.</li>
        </ul>
      </div>

      <div class="card">
        <h3>How we’ll present each tool</h3>
        <ul class="small clean">
          <li>Our photo (not a stock image)</li>
          <li>What we use it for</li>
          <li>One tip we wish we knew earlier</li>
          <li>Optional link for reference</li>
        </ul>
        <div class="hr"></div>
        <p class="small">
          Start with 20 tools. Once the layout feels right, we can scale up to hundreds quickly.
        </p>
      </div>
    </div>

    <div class="card" style="margin-top:14px">
      <div class="grid" style="grid-template-columns:1fr 220px 220px;gap:10px;align-items:end">
        <div>
          <label class="small">Search</label>
          <input id="toolSearch" class="input" placeholder="Type a tool name…" />
        </div>

        <div>
          <label class="small">Area</label>
          <select id="toolArea" class="input">
            <option value="all">All</option>
          </select>
        </div>

        <div>
          <label class="small">Category</label>
          <select id="toolCat" class="input">
            <option value="all">All</option>
          </select>
        </div>
      </div>

      <div class="small" style="margin-top:10px">
        Showing <span id="toolShown">0</span> of <span id="toolTotal">0</span>
      </div>

      <div id="toolsGrid" class="grid" style="margin-top:12px"></div>

      <div class="small" style="margin-top:12px">
        Links go to an Amazon.ca search page (not affiliate links). We use our own photos whenever possible.
      </div>
    </div>

    <div class="footer">
      Upload for this page: 20 tool photos + 5 “in-progress” action shots (hands working, setups, jig shots).
    </div>
  </div>

  <script src="/js/main.js"></script>
  <script>
    const $ = (sel) => document.querySelector(sel);

    // Fallback if main.js doesn't define it globally
    const escapeHtml = window.escapeHtml || ((s) => String(s ?? '')
      .replaceAll('&', '&amp;')
      .replaceAll('<', '&lt;')
      .replaceAll('>', '&gt;')
      .replaceAll('"', '&quot;')
      .replaceAll("'", '&#39;')
    );

    // =========================
    // R2 IMAGE CONFIG
    // =========================
    const ASSET_ORIGIN = "https://assets.devilndove.com";

    // If your R2 objects live under a folder, set it like: "/toolshed"
    // If your objects are at bucket root, leave "".
    const ASSET_PREFIX = "/toolshed"; // e.g. "/toolshed"

    function toolImageUrl(pathOrFile){
      if (!pathOrFile) return "";
      const p = String(pathOrFile);

      // Already absolute URL
      if (/^https?:\/\//i.test(p)) return p;

      // Convert "/assets/tools/whatever.jpg" -> "whatever.jpg"
      const fileName = p.includes("/") ? p.split("/").pop() : p;

      const prefix = ASSET_PREFIX ? ASSET_PREFIX.replace(/\/+$/,'') : "";
      return `${ASSET_ORIGIN}${prefix}/${encodeURIComponent(fileName)}`;
    }

    function amazonSearchUrl(name){
      return `https://www.amazon.ca/s?k=${encodeURIComponent(name || "")}`;
    }

    const grid = $('#toolsGrid');
    const search = $('#toolSearch');
    const areaSel = $('#toolArea');
    const catSel = $('#toolCat');
    const shown = $('#toolShown');
    const total = $('#toolTotal');

    const AREA_ORDER = [
      "Security",
      "Safety & PPE",
      "Forge & Metalwork",
      "Resin & UV",
      "Clay",
      "Laser & Engraving",
      "3D & CNC",
      "Sublimation",
      "Craft & Cutting",
      "Hand Tools",
      "Measuring & Layout",
      "Organization & Storage",
      "Power & Tech",
      "Filming & Streaming",
      "Automotive",
      "Reference",
      "Pets",
      "Health & Comfort",
      "Workshop Basics"
    ];
    const areaRank = new Map(AREA_ORDER.map((a, i) => [a, i]));

    const norm = (s) => (s || '').toString().toLowerCase().trim();
    const getArea = (t) => t.area || 'Workshop Basics';

    const byAreaThenName = (a, b) => {
      const ra = areaRank.has(a) ? areaRank.get(a) : 999;
      const rb = areaRank.has(b) ? areaRank.get(b) : 999;
      if (ra !== rb) return ra - rb;
      return a.localeCompare(b);
    };

    function buildCard(t){
      const tags = `
        <div class="tags">
          <span class="tag">${escapeHtml(getArea(t))}</span>
          <span class="tag">${escapeHtml(t.category || 'Uncategorized')}</span>
        </div>`;

      const img = toolImageUrl(t.image || t.example_image_file);
      const name = t.name || t.item_name_suggested || t.example_image_file || "Tool";

      const amz = t.amazon_search || t.amazon_url || amazonSearchUrl(name);

      return `
        <div class="tool card">
          <div class="thumb">
            <img src="${img}" alt="${escapeHtml(name)}" loading="lazy">
          </div>
          <div class="body">
            <div class="tname">${escapeHtml(name)}</div>
            <div class="meta">
              ${tags}
              ${t.how_we_use ? `<div class="use">${escapeHtml(t.how_we_use)}</div>` : ''}
              <a class="amz" href="${amz}" target="_blank" rel="noopener">Amazon.ca search</a>
            </div>
          </div>
        </div>`;
    }

    function render(list, totalCount){
      shown.textContent = String(list.length);
      total.textContent = String(totalCount);

      const groups = {};
      list.forEach(t => {
        const a = getArea(t);
        (groups[a] ||= []).push(t);
      });

      Object.keys(groups).forEach(a => groups[a].sort((x,y) => (x.name||x.item_name_suggested||'').localeCompare(y.name||y.item_name_suggested||'')));

      const areas = Object.keys(groups).sort(byAreaThenName);

      grid.innerHTML = areas.map(a => `
        <section class="area-block">
          <div class="area-head">
            <h2>${escapeHtml(a)}</h2>
            <div class="muted">${groups[a].length} item${groups[a].length === 1 ? '' : 's'}</div>
          </div>
          <div class="subgrid">
            ${groups[a].map(buildCard).join('')}
          </div>
        </section>
      `).join('');
    }

    function applyFilters(tools, totalCount){
      const term = norm(search.value);
      const areaVal = areaSel.value;
      const catVal = catSel.value;

      let list = tools.slice();

      if(areaVal !== 'all') list = list.filter(t => getArea(t) === areaVal);
      if(catVal !== 'all') list = list.filter(t => (t.category || 'Uncategorized') === catVal);

      if(term){
        list = list.filter(t => {
          const name = t.name || t.item_name_suggested || '';
          const hay = norm(name) + ' ' + norm(t.category) + ' ' + norm(getArea(t)) + ' ' + norm(t.how_we_use);
          return hay.includes(term);
        });
      }

      render(list, totalCount);
    }

    async function fetchFirst(urls){
      for (const u of urls){
        try {
          const res = await fetch(u, { cache: "no-store" });
          if (res.ok) return { url: u, data: await res.json() };
        } catch (e) {}
      }
      return null;
    }

    function normalizeTools(payload){
      // Schema A: /data/tools.json
      if (payload && Array.isArray(payload.items)) {
        return {
          tools: payload.items.slice(),
          totalCount: Number(payload.count) || payload.items.length
        };
      }

      // Schema B: toolshed_items_master.json (array)
      if (Array.isArray(payload)) {
        const tools = payload.map(it => ({
          name: it.item_name_suggested || it.example_image_file,
          image: it.example_image_file,   // filename
          category: it.category || "Uncategorized",
          area: it.primary_area || "Workshop Basics",
          how_we_use: it.notes || "",
          amazon_search: it.amazon_url || (it.amazon_asin ? `https://www.amazon.ca/dp/${it.amazon_asin}` : "")
        }));
        return { tools, totalCount: tools.length };
      }

      return { tools: [], totalCount: 0 };
    }

    async function init(){
      const result = await fetchFirst([
        "/data/tools.json",
        "/data/toolshed/toolshed_items_master.json",
        "/data/toolshed_items_master.json"
      ]);

      if (!result) {
        grid.innerHTML = `<div class="small">Could not load tools data.</div>`;
        return;
      }

      const { tools, totalCount } = normalizeTools(result.data);

      // Populate Area filter
      const areas = Array.from(new Set(tools.map(getArea))).sort(byAreaThenName);
      areas.forEach(a => {
        const opt = document.createElement('option');
        opt.value = a;
        opt.textContent = a;
        areaSel.appendChild(opt);
      });

      // Populate Category filter
      const cats = Array.from(new Set(tools.map(t => t.category || 'Uncategorized'))).sort((a,b)=>a.localeCompare(b));
      cats.forEach(c => {
        const opt = document.createElement('option');
        opt.value = c;
        opt.textContent = c;
        catSel.appendChild(opt);
      });

      const onChange = () => applyFilters(tools, totalCount);
      search.addEventListener('input', onChange);
      areaSel.addEventListener('change', onChange);
      catSel.addEventListener('change', onChange);

      applyFilters(tools, totalCount);
    }

    init();
  </script>
</body>
</html>

